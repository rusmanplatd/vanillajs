<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reactive Forms Example</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }

      .form-section {
        margin-bottom: 40px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }

      input.invalid {
        border-color: #dc3545;
      }

      input.valid {
        border-color: #28a745;
      }

      .error {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
      }

      .status {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-top: 15px;
      }

      button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      .array-item {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .remove-btn {
        background-color: #dc3545;
        padding: 5px 10px;
        margin-top: 10px;
      }

      .remove-btn:hover {
        background-color: #c82333;
      }

      pre {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>Reactive Forms Example</h1>

    <!-- Simple Form -->
    <div class="form-section">
      <h2>Simple Form with Validation</h2>
      <form id="simple-form">
        <div class="form-group">
          <label for="name">Name (required):</label>
          <input type="text" id="name" />
          <div id="name-error" class="error"></div>
        </div>

        <div class="form-group">
          <label for="email">Email (required, must be valid):</label>
          <input type="email" id="email" />
          <div id="email-error" class="error"></div>
        </div>

        <div class="form-group">
          <label for="age">Age (must be between 18 and 100):</label>
          <input type="number" id="age" />
          <div id="age-error" class="error"></div>
        </div>

        <button type="submit" id="simple-submit">Submit</button>
        <button type="button" id="simple-reset">Reset</button>

        <div class="status">
          <strong>Form Status:</strong>
          <div id="simple-status"></div>
        </div>

        <div class="status">
          <strong>Form Value:</strong>
          <pre id="simple-value"></pre>
        </div>
      </form>
    </div>

    <!-- Form Group Example -->
    <div class="form-section">
      <h2>User Registration Form</h2>
      <form id="registration-form">
        <div class="form-group">
          <label for="username">Username (3-20 characters):</label>
          <input type="text" id="username" />
          <div id="username-error" class="error"></div>
        </div>

        <div class="form-group">
          <label for="reg-email">Email:</label>
          <input type="email" id="reg-email" />
          <div id="reg-email-error" class="error"></div>
        </div>

        <div class="form-group">
          <label for="password">Password (min 8 characters):</label>
          <input type="password" id="password" />
          <div id="password-error" class="error"></div>
        </div>

        <div class="form-group">
          <label for="bio">Bio (max 200 characters):</label>
          <input type="text" id="bio" />
          <div id="bio-error" class="error"></div>
        </div>

        <button type="submit" id="reg-submit">Register</button>
        <button type="button" id="reg-reset">Reset</button>

        <div class="status">
          <strong>Form Status:</strong>
          <div id="reg-status"></div>
        </div>

        <div class="status">
          <strong>Form Value:</strong>
          <pre id="reg-value"></pre>
        </div>
      </form>
    </div>

    <!-- Form Array Example -->
    <div class="form-section">
      <h2>Dynamic Phone Numbers (FormArray)</h2>
      <form id="phones-form">
        <div id="phones-container"></div>

        <button type="button" id="add-phone">Add Phone Number</button>
        <button type="submit" id="phones-submit">Submit</button>
        <button type="button" id="phones-reset">Reset</button>

        <div class="status">
          <strong>Form Status:</strong>
          <div id="phones-status"></div>
        </div>

        <div class="status">
          <strong>Form Value:</strong>
          <pre id="phones-value"></pre>
        </div>
      </form>
    </div>

    <script type="module">
      import { FormControl, FormGroup, FormArray, Validators } from '../src/forms.js';

      // ========== SIMPLE FORM ==========
      const nameControl = new FormControl('', [Validators.required]);
      const emailControl = new FormControl('', [Validators.required, Validators.email]);
      const ageControl = new FormControl('', [Validators.min(18), Validators.max(100)]);

      const simpleForm = new FormGroup({
        name: nameControl,
        email: emailControl,
        age: ageControl,
      });

      // Bind inputs to controls
      document.getElementById('name').addEventListener('input', (e) => {
        nameControl.setValue(e.target.value);
      });
      document.getElementById('name').addEventListener('blur', () => {
        nameControl.markAsTouched();
      });

      document.getElementById('email').addEventListener('input', (e) => {
        emailControl.setValue(e.target.value);
      });
      document.getElementById('email').addEventListener('blur', () => {
        emailControl.markAsTouched();
      });

      document.getElementById('age').addEventListener('input', (e) => {
        ageControl.setValue(e.target.value);
      });
      document.getElementById('age').addEventListener('blur', () => {
        ageControl.markAsTouched();
      });

      // Subscribe to value changes
      simpleForm.valueChanges.subscribe((value) => {
        document.getElementById('simple-value').textContent = JSON.stringify(value, null, 2);
      });

      // Subscribe to status changes
      simpleForm.statusChanges.subscribe(() => {
        const statusEl = document.getElementById('simple-status');
        statusEl.textContent = `Valid: ${simpleForm.valid}, Touched: ${simpleForm.touched}, Dirty: ${simpleForm.dirty}`;

        // Update submit button
        document.getElementById('simple-submit').disabled = !simpleForm.valid;
      });

      // Error display for name
      nameControl.errorChanges.subscribe((errors) => {
        const errorEl = document.getElementById('name-error');
        const inputEl = document.getElementById('name');

        if (errors && nameControl.touched) {
          errorEl.textContent = errors.required ? 'Name is required' : '';
          inputEl.classList.add('invalid');
          inputEl.classList.remove('valid');
        } else if (nameControl.touched) {
          errorEl.textContent = '';
          inputEl.classList.add('valid');
          inputEl.classList.remove('invalid');
        } else {
          errorEl.textContent = '';
          inputEl.classList.remove('valid', 'invalid');
        }
      });

      // Error display for email
      emailControl.errorChanges.subscribe((errors) => {
        const errorEl = document.getElementById('email-error');
        const inputEl = document.getElementById('email');

        if (errors && emailControl.touched) {
          if (errors.required) {
            errorEl.textContent = 'Email is required';
          } else if (errors.email) {
            errorEl.textContent = 'Invalid email format';
          }
          inputEl.classList.add('invalid');
          inputEl.classList.remove('valid');
        } else if (emailControl.touched) {
          errorEl.textContent = '';
          inputEl.classList.add('valid');
          inputEl.classList.remove('invalid');
        } else {
          errorEl.textContent = '';
          inputEl.classList.remove('valid', 'invalid');
        }
      });

      // Error display for age
      ageControl.errorChanges.subscribe((errors) => {
        const errorEl = document.getElementById('age-error');
        const inputEl = document.getElementById('age');

        if (errors && ageControl.touched) {
          if (errors.min) {
            errorEl.textContent = `Age must be at least ${errors.min.min}`;
          } else if (errors.max) {
            errorEl.textContent = `Age must be at most ${errors.max.max}`;
          }
          inputEl.classList.add('invalid');
          inputEl.classList.remove('valid');
        } else if (ageControl.touched) {
          errorEl.textContent = '';
          inputEl.classList.add('valid');
          inputEl.classList.remove('invalid');
        } else {
          errorEl.textContent = '';
          inputEl.classList.remove('valid', 'invalid');
        }
      });

      // Form submit
      document.getElementById('simple-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (simpleForm.valid) {
          console.log('Simple form submitted:', simpleForm.value);
          alert('Form submitted! Check console for values.');
        }
      });

      // Form reset
      document.getElementById('simple-reset').addEventListener('click', () => {
        simpleForm.reset();
        document.getElementById('name').value = '';
        document.getElementById('email').value = '';
        document.getElementById('age').value = '';
      });

      // ========== REGISTRATION FORM ==========
      const registrationForm = new FormGroup({
        username: new FormControl('', [Validators.required, Validators.minLength(3), Validators.maxLength(20)]),
        email: new FormControl('', [Validators.required, Validators.email]),
        password: new FormControl('', [Validators.required, Validators.minLength(8)]),
        bio: new FormControl('', [Validators.maxLength(200)]),
      });

      // Bind registration form
      const regFields = ['username', 'reg-email', 'password', 'bio'];
      const regControlNames = ['username', 'email', 'password', 'bio'];

      regFields.forEach((fieldId, index) => {
        const controlName = regControlNames[index];
        const control = registrationForm.get(controlName);
        const inputEl = document.getElementById(fieldId);

        inputEl.addEventListener('input', (e) => {
          control.setValue(e.target.value);
        });

        inputEl.addEventListener('blur', () => {
          control.markAsTouched();
        });

        // Error display
        control.errorChanges.subscribe((errors) => {
          const errorEl = document.getElementById(`${controlName}-error`);

          if (errors && control.touched) {
            let errorMsg = '';
            if (errors.required) errorMsg = 'This field is required';
            else if (errors.email) errorMsg = 'Invalid email format';
            else if (errors.minLength) errorMsg = `Minimum ${errors.minLength.requiredLength} characters`;
            else if (errors.maxLength) errorMsg = `Maximum ${errors.maxLength.requiredLength} characters`;

            errorEl.textContent = errorMsg;
            inputEl.classList.add('invalid');
            inputEl.classList.remove('valid');
          } else if (control.touched) {
            errorEl.textContent = '';
            inputEl.classList.add('valid');
            inputEl.classList.remove('invalid');
          } else {
            errorEl.textContent = '';
            inputEl.classList.remove('valid', 'invalid');
          }
        });
      });

      registrationForm.valueChanges.subscribe((value) => {
        document.getElementById('reg-value').textContent = JSON.stringify(value, null, 2);
      });

      registrationForm.statusChanges.subscribe(() => {
        document.getElementById('reg-status').textContent =
          `Valid: ${registrationForm.valid}, Touched: ${registrationForm.touched}, Dirty: ${registrationForm.dirty}`;
        document.getElementById('reg-submit').disabled = !registrationForm.valid;
      });

      document.getElementById('registration-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (registrationForm.valid) {
          console.log('Registration form submitted:', registrationForm.value);
          alert('Registration successful! Check console for values.');
        }
      });

      document.getElementById('reg-reset').addEventListener('click', () => {
        registrationForm.reset();
        regFields.forEach((fieldId) => {
          document.getElementById(fieldId).value = '';
        });
      });

      // ========== FORM ARRAY (PHONE NUMBERS) ==========
      const phoneArray = new FormArray([]);

      function createPhoneControl() {
        return new FormControl('', [Validators.required, Validators.pattern(/^\d{3}-\d{3}-\d{4}$/)]);
      }

      function renderPhoneArray() {
        const container = document.getElementById('phones-container');
        container.innerHTML = '';

        phoneArray.controls.forEach((control, index) => {
          const div = document.createElement('div');
          div.className = 'array-item';

          const label = document.createElement('label');
          label.textContent = `Phone ${index + 1} (format: 123-456-7890):`;
          div.appendChild(label);

          const input = document.createElement('input');
          input.type = 'text';
          input.value = control.value;

          input.addEventListener('input', (e) => {
            control.setValue(e.target.value);
          });

          input.addEventListener('blur', () => {
            control.markAsTouched();
          });

          div.appendChild(input);

          const errorDiv = document.createElement('div');
          errorDiv.className = 'error';
          div.appendChild(errorDiv);

          control.errorChanges.subscribe((errors) => {
            if (errors && control.touched) {
              if (errors.required) {
                errorDiv.textContent = 'Phone number is required';
              } else if (errors.pattern) {
                errorDiv.textContent = 'Format must be 123-456-7890';
              }
              input.classList.add('invalid');
              input.classList.remove('valid');
            } else if (control.touched) {
              errorDiv.textContent = '';
              input.classList.add('valid');
              input.classList.remove('invalid');
            } else {
              errorDiv.textContent = '';
              input.classList.remove('valid', 'invalid');
            }
          });

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'remove-btn';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', () => {
            phoneArray.removeAt(index);
            renderPhoneArray();
          });

          div.appendChild(removeBtn);
          container.appendChild(div);
        });
      }

      phoneArray.valueChanges.subscribe((value) => {
        document.getElementById('phones-value').textContent = JSON.stringify(value, null, 2);
      });

      phoneArray.statusChanges.subscribe(() => {
        document.getElementById('phones-status').textContent =
          `Valid: ${phoneArray.valid}, Length: ${phoneArray.length}`;
        document.getElementById('phones-submit').disabled = !phoneArray.valid;
      });

      document.getElementById('add-phone').addEventListener('click', () => {
        phoneArray.push(createPhoneControl());
        renderPhoneArray();
      });

      document.getElementById('phones-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (phoneArray.valid) {
          console.log('Phone numbers submitted:', phoneArray.value);
          alert('Phone numbers saved! Check console for values.');
        }
      });

      document.getElementById('phones-reset').addEventListener('click', () => {
        phoneArray.clear();
        renderPhoneArray();
      });

      // Initialize with one phone field
      phoneArray.push(createPhoneControl());
      renderPhoneArray();
    </script>
  </body>
</html>
